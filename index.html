<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dance Vote ¬∑ Pop & Zoom üíú</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;--card:#1f2937;--accent:#f472b6;--accent-2:#38bdf8;--text:#e5e7eb;--muted:#9ca3af;
      --ok:#6ee7b7;--err:#fca5a5;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{
      font-family:"Nunito",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top,#1f2937 0,#020617 55%);
      color:var(--text); min-height:100vh;
    }
    .app{
      max-width:720px; margin:0 auto;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.25);
      border-radius:20px;
      padding:16px 14px 92px;
      position:relative; overflow:hidden;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
    }
    .blob{position:absolute;width:220px;height:220px;border-radius:999px;filter:blur(40px);opacity:.22;pointer-events:none}
    .blob.pink{background:#f472b6;top:-80px;right:-60px}
    .blob.blue{background:#38bdf8;bottom:-120px;left:-40px}
    .app-inner{position:relative;z-index:1}

    header{display:flex;flex-direction:column;gap:12px;margin-bottom:10px}
    .title{font-size:1.5rem;font-weight:800}
    .subtitle{color:var(--muted)}
    .name-form{
      display:flex;gap:12px;align-items:center;
      border:1px solid rgba(148,163,184,.5);
      padding:12px 14px;border-radius:16px;
      background:linear-gradient(135deg,rgba(56,189,248,.1),rgba(244,114,182,.08));
      box-shadow:0 8px 28px rgba(0,0,0,.35);
    }
    .name-form label{
      color:var(--muted);
      font-weight:800;
      letter-spacing:.01em;
    }
    .name-form:focus-within{
      border-color:rgba(56,189,248,.8);
      box-shadow:0 10px 30px rgba(56,189,248,.2);
    }
    .name-form input{
      flex:1;background:transparent;border:none;outline:none;
      color:var(--text);padding:10px 8px;font-size:1rem;
      font-weight:700;
    }
    .btn{
      border:none;border-radius:999px;padding:10px 14px;
      cursor:pointer;font-weight:800;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#0b1120;
    }

    /* Thumbnail row with titles below */
    .thumbs{
      display:flex;justify-content:space-between;gap:10px;
      margin-top:10px;
    }
    .thumb-item{
      flex:1;display:flex;flex-direction:column;
      align-items:center;gap:6px;min-width:0;
    }
    .thumb{
      width:100px;height:100px;
      border-radius:999px;
      position:relative;flex:0 0 auto;
      border:3px solid rgba(244,114,182,.45);
      box-shadow:0 10px 24px rgba(0,0,0,.45);
      overflow:hidden;background:#000;
      padding:0;
      cursor:pointer;
    }
    .thumb video{
      width:100%;height:100%;
      object-fit:cover;display:block;
    }
    .thumb-title{
      font-size:.85rem;text-align:center;
      color:var(--text);
      max-width:7rem;
      white-space:normal;
    }
    .select-inline{
      margin-top:4px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.7);
      color:var(--text);
      border-radius:12px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease;
    }
    .select-inline:hover{transform:translateY(-1px);border-color:rgba(244,114,182,.7)}
    .select-inline.selected{
      background:rgba(110,231,183,.12);
      border-color:var(--ok);
      color:var(--ok);
    }
    .thumb.selected{
      outline:3px solid var(--ok);
      box-shadow:0 0 0 6px rgba(110,231,183,.15);
    }

    /* Sticky submit bar */
    .submit-bar{position:sticky;bottom:0;left:0;right:0;margin-top:16px}
    .submit-inner{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(180deg,rgba(2,6,23,0) 0%,rgba(2,6,23,.6) 15%,rgba(2,6,23,.9) 100%);
      padding:12px 10px 14px;
      border-top:1px dashed rgba(148,163,184,.4);
      backdrop-filter:blur(6px);
      border-bottom-left-radius:20px;
      border-bottom-right-radius:20px;
    }
    .status{min-height:1.2em}
    .status.error{color:var(--err)}
    .status.ok{color:var(--ok)}
    .submit-btn{
      border:none;border-radius:999px;
      padding:12px 18px;font-weight:900;font-size:1rem;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#0b1120;
      box-shadow:0 10px 24px rgba(0,0,0,.5);
      position:relative;overflow:hidden;
    }
    .submit-btn:disabled{opacity:.55;cursor:not-allowed}
    .submit-btn.submitted{
      cursor:not-allowed;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .submit-btn.celebrating::after{
      content:"";
      position:absolute;inset:-30%;pointer-events:none;
      background:radial-gradient(circle at 20% 20%,rgba(255,255,255,.8),rgba(255,255,255,0) 35%),
                 radial-gradient(circle at 80% 30%,rgba(255,255,255,.7),rgba(255,255,255,0) 30%),
                 linear-gradient(120deg,rgba(255,255,255,.0) 0%,rgba(255,255,255,.45) 50%,rgba(255,255,255,0) 100%);
      mix-blend-mode:screen;
      animation:glitter 0.9s ease-out forwards;
    }
    @keyframes glitter{
      from{transform:translateX(-30%) rotate(0deg);opacity:1}
      to{transform:translateX(30%) rotate(5deg);opacity:0}
    }
    .confetti-canvas{
      position:fixed;inset:0;pointer-events:none;z-index:60;
    }
    .results-footer{
      display:none;
      margin:14px auto 0;
      text-align:center;
    }
    .results-btn{
      border:1px solid rgba(148,163,184,.5);
      border-radius:999px;
      padding:12px 16px;
      color:var(--text);
      text-decoration:none;
      font-weight:800;
      background:rgba(15,23,42,.85);
      transition:transform .12s ease,border-color .12s ease;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
    }
    .results-btn:hover{transform:translateY(-1px);border-color:rgba(244,114,182,.7)}

    /* Fullscreen modal */
    .modal{
      position:fixed;inset:0;
      display:none;
      align-items:center;justify-content:center;
      background:rgba(2,6,23,.75);
      backdrop-filter:blur(6px);
      z-index:50;
    }
    .modal.open{display:flex}
    .viewer{
      position:relative;
      width:min(92vw,480px);
      aspect-ratio:9/16;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      background:#000;
    }
    .viewer video{width:100%;height:100%;object-fit:cover;display:block}
    .viewer-title{
      position:absolute;
      top:10px;left:50%;transform:translateX(-50%);
      background:rgba(2,6,23,.85);
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      font-weight:700;
      font-size:.9rem;
    }
    .close{
      position:absolute;top:10px;left:10px;
      border:none;border-radius:999px;
      padding:6px 10px;font-weight:900;cursor:pointer;
      background:rgba(2,6,23,.85);
      color:var(--text);
      border:1px solid rgba(148,163,184,.5);
    }
    .select-btn{
      position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
      border:none;border-radius:999px;
      padding:10px 16px;font-weight:900;cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#0b1120;
      box-shadow:0 10px 24px rgba(0,0,0,.5);
    }

    @media (min-width:420px){
      .thumb{width:120px;height:120px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="blob pink"></div><div class="blob blue"></div>
    <div class="app-inner">
      <header>
        <div class="title">Dance Video Voting ‚Äî tap a circle to preview</div>
        <p class="subtitle">Type your name, preview each clip fullscreen, and pick your <b>top two</b>.</p>
        <form id="name-form" class="name-form" onsubmit="return false;">
          <label for="name-input">Name</label>
          <input id="name-input" type="text" placeholder="e.g. Kiki..." autocomplete="off" />
        </form>
      </header>

      <!-- Circular thumbnails with titles below -->
      <section class="thumbs">
        <div class="thumb-item">
          <button class="thumb" data-name="Spaghetti" data-src="video/spaghetti.mp4" aria-label="Open Spaghetti">
            <video
              muted
              autoplay
              loop
              playsinline
              preload="metadata"
              <!-- optional: poster="img/spaghetti_poster.jpg" -->
            >
              <source src="video/spaghetti.mp4" type="video/mp4">
            </video>
          </button>
          <div class="thumb-title">Spaghetti</div>
          <button class="select-inline" type="button" data-name="Spaghetti">Select</button>
        </div>

        <div class="thumb-item">
          <button class="thumb" data-name="Strategy" data-src="video/strategy.mp4" aria-label="Open Strategy">
            <video
              muted
              autoplay
              loop
              playsinline
              preload="metadata"
              <!-- optional: poster="img/strategy_poster.jpg" -->
            >
              <source src="video/strategy.mp4" type="video/mp4">
            </video>
          </button>
          <div class="thumb-title">Strategy</div>
          <button class="select-inline" type="button" data-name="Strategy">Select</button>
        </div>

        <div class="thumb-item">
          <button class="thumb" data-name="Sports Car" data-src="video/sports_car.mp4" aria-label="Open Sports Car">
            <video
              muted
              autoplay
              loop
              playsinline
              preload="metadata"
              <!-- optional: poster="img/sports_car_poster.jpg" -->
            >
              <source src="video/sports_car.mp4" type="video/mp4">
            </video>
          </button>
          <div class="thumb-title">Sports Car</div>
          <button class="select-inline" type="button" data-name="Sports Car">Select</button>
        </div>
      </section>

      <!-- Sticky submit -->
      <div class="submit-bar">
        <div class="submit-inner">
      <div>
        <div id="status" class="status"></div>
        <div class="subtitle">Selected: <span id="count">0/2</span></div>
      </div>
      <button id="submit-btn" class="submit-btn" disabled>Submit votes</button>
    </div>
  </div>
  <div id="results-footer" class="results-footer">
    <a id="results-link" class="results-btn" href="results.html" target="_blank" rel="noopener">üìä See live results</a>
  </div>
    </div>
  </div>

  <!-- Fullscreen modal viewer -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="viewer">
      <button class="close" id="close">‚úï</button>
      <div class="viewer-title" id="viewer-title"></div>
      <video id="player" controls playsinline preload="metadata"></video>
      <button id="pick" class="select-btn">Select this</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySrA8feUCAfmKFDet3RRsHiY28f4dzgIh1puQgVwNdBEvV9vGNe2ESIQC1GxHma02M/exec"; // replace with your real URL

    // ===== ELEMENTS =====
    const nameInput = document.getElementById('name-input');
    const statusEl  = document.getElementById('status');
    const countEl   = document.getElementById('count');
    const submitBtn = document.getElementById('submit-btn');
    const resultsLink = document.getElementById('results-link');
    const resultsFooter = document.getElementById('results-footer');
    const thumbs    = Array.from(document.querySelectorAll('.thumb'));
    const inlineSelects = Array.from(document.querySelectorAll('.select-inline'));

    const modal      = document.getElementById('modal');
    const player     = document.getElementById('player');
    const pickBtn    = document.getElementById('pick');
    const closeBtn   = document.getElementById('close');
    const viewerTitle= document.getElementById('viewer-title');

    // ===== STATE =====
    const chosen = new Set();          // selected video names
    const submittedNames = new Set();  // to prevent double-vote by name
    let currentVideo = { name: "", src: "" };
    let submitting = false;
    let hasSubmitted = false;

    // ===== HELPERS =====
    const setStatus = (msg, ok=false) => {
      statusEl.textContent = msg || "";
      statusEl.classList.toggle('ok', ok);
      statusEl.classList.toggle('error', !ok && !!msg);
    };

    // Pre-warm the Apps Script (helps avoid cold start delay)
    fetch(APP_SCRIPT_URL + '?ping=1', { method:'GET', mode:'no-cors' }).catch(()=>{});

    // quick page-wide glitter burst
    const fireConfetti = () => {
      const canvas = document.createElement('canvas');
      canvas.className = 'confetti-canvas';
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const { innerWidth:w, innerHeight:h } = window;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = `${w}px`;
      canvas.style.height = `${h}px`;
      ctx.scale(dpr, dpr);
      document.body.appendChild(canvas);

      const colors = ['#f472b6','#38bdf8','#6ee7b7','#facc15','#f97316'];
      const pieces = Array.from({length:100}, ()=>({
        x: Math.random()*w,
        y: -20 - Math.random()*40,
        r: 6 + Math.random()*6,
        vy: 3 + Math.random()*5,
        vx: (Math.random()-0.5)*2,
        rot: Math.random()*Math.PI,
        vr: (Math.random()-0.5)*0.2,
        color: colors[Math.floor(Math.random()*colors.length)],
        opacity: 0.7 + Math.random()*0.3
      }));

      let running = true;
      const draw = () => {
        if (!running) return;
        ctx.clearRect(0,0,w,h);
        pieces.forEach(p=>{
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.vy += 0.08; // gravity
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.color;
          ctx.globalAlpha = p.opacity;
          ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*1.4);
          ctx.restore();
        });
        requestAnimationFrame(draw);
      };
      draw();
      setTimeout(()=>{
        running = false;
        canvas.remove();
      }, 1200);
    };

    const syncSubmit = () => {
      if (hasSubmitted) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitted ‚ú®";
        setStatus("Vote submitted. Refresh to vote again.", true);
        if (resultsFooter && resultsLink) {
          resultsFooter.style.display = 'block';
          resultsLink.href = `results.html?ts=${Date.now()}`;
        }
        return;
      }
      if (resultsFooter) resultsFooter.style.display = 'none';
      const n = nameInput.value.trim();
      const ready = !!n && chosen.size === 2;
      countEl.textContent = `${chosen.size}/2`;
      submitBtn.disabled = !ready;

      if (!n) {
        setStatus("Type your name so we can count your vote üìù");
      } else if (chosen.size < 2) {
        setStatus(`Hi ${n}! Pick exactly two videos ‚úåÔ∏è`);
      } else {
        setStatus(`Ready to submit, ${n}!`, true);
      }
    };

    const updateSelectionUI = (name) => {
      const isSelected = chosen.has(name);
      const thumb = document.querySelector(`.thumb[data-name="${name}"]`);
      const inlineBtn = document.querySelector(`.select-inline[data-name="${name}"]`);
      if (thumb) thumb.classList.toggle('selected', isSelected);
      if (inlineBtn) {
        inlineBtn.classList.toggle('selected', isSelected);
        inlineBtn.textContent = isSelected ? "Unselect" : "Select";
      }
      if (currentVideo.name === name && pickBtn) {
        pickBtn.textContent = isSelected ? "Unselect" : "Select this";
      }
    };

    const toggleSelection = (name) => {
      if (chosen.has(name)) {
        chosen.delete(name);
      } else {
        if (chosen.size >= 2) {
          setStatus("You can only pick 2 videos üí°");
          return;
        }
        chosen.add(name);
      }
      updateSelectionUI(name);
      syncSubmit();
    };

    const openModal = (name, src) => {
      currentVideo = { name, src };
      viewerTitle.textContent = name;
      player.src = src;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      player.play().catch(()=>{});
      pickBtn.textContent = chosen.has(name) ? "Unselect" : "Select this";
    };

    const closeModal = () => {
      player.pause();
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    };

    // ===== UI EVENTS =====
    nameInput.addEventListener('input', syncSubmit);
    nameInput.addEventListener('blur', syncSubmit);

    thumbs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        openModal(btn.dataset.name, btn.dataset.src);
      });
    });

    // Select/unselect directly on the main page
    inlineSelects.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        toggleSelection(btn.dataset.name);
      });
    });

    // Toggle selection in modal
    pickBtn.addEventListener('click', ()=>{
      toggleSelection(currentVideo.name);
    });

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    // Submit votes to Google Apps Script
    submitBtn.addEventListener('click', async ()=>{
      if (submitting) return;
      const name = nameInput.value.trim();
      if(!name){ setStatus("Please enter your name first üêæ"); return; }
      if(chosen.size !== 2){ setStatus("Select exactly two videos ‚úåÔ∏è"); return; }
      if(submittedNames.has(name.toLowerCase())){
        setStatus("Looks like you've already voted. Thank you! ü´∂");
        return;
      }

      submitting = true;
      submitBtn.disabled = true;
      setStatus("Submitting your votes‚Ä¶");
      const votes = Array.from(chosen);
      try {
        await fetch(APP_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors", // avoid CORS blocking
          body: JSON.stringify({ name, votes, userAgent: navigator.userAgent })
        });
        hasSubmitted = true;
        const key = `voted-${name.toLowerCase()}`;
        const wasUpdate = !!localStorage.getItem(key);
        localStorage.setItem(key, votes.join('|'));
        submittedNames.add(name.toLowerCase());
        const msg = wasUpdate
          ? `You voted before; updated to ${votes.join(" + ")} ‚úÖ`
          : `Thanks, ${name}! You voted for ${votes.join(" + ")} ‚ú®`;
        setStatus(msg, true);
        submitBtn.textContent = "Submitted ‚ú®";
        submitBtn.classList.add('submitted','celebrating');
        submitBtn.disabled = true;
        setTimeout(()=>submitBtn.classList.remove('celebrating'), 1000);
        fireConfetti();
        if (resultsFooter && resultsLink) {
          resultsFooter.style.display = 'block';
          resultsLink.href = `results.html?ts=${Date.now()}`;
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch {
        setStatus("Sorry, there was a problem saving your vote. Try again.");
        submitting = false;
        syncSubmit(); // re-enable if allowed
      }
    });

    // Initial
    syncSubmit();
  </script>
</body>
</html>
